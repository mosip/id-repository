## What is Handle?

A Handle is a unique but changeable ID that`s possessed by the user or auto-generated by the system. It can be a user's email, phone number, an existing functional ID/sectoral ID/national ID in the country. It can also be a username created by the user. 

Typically Handles are IDs that are easy to remember and frequently used by the user. Handles come helpful when the 12/16 digit numbers are too large to remember. In certain cases, MOSIP would be used to replace an existing ID system and the IDs generated by that old system can become a handle in MOSIP and users can use the same to authenticate. This helps to adopt the usage of MOSIP with less user training. 

As handles are revocable they provide strong privacy by default. If a user feels a handle is compromised they could alter and move to a new handle without losing any history of their transactions. 

## Principles

* Users could have more than one handle mapped to his/her UIN.
* Handles should be case-insensitive.
* The usage of handles should be driven through policy.
* Users should be given the freedom to choose which handles to use.

## Create Handle

* Mark a field to be a handle in the Identity schema.
* Introduced reserved field `selectedHandles` that holds the user's selected handle `fieldIds` list.
* Table `mosip_idrepo.handle` will hold the hash of the handle linked with UIN.
* Changes in `add_identity` API:
    1. Identify if any handle is selected in the input.
    2. Check if the selected handles are configured as a HANDLE in `identity_schema`(JSON schema validation).
    3. If no handles are selected, proceed with step 7.
    4. Get the salt for the input handle and generate the selected handle salted hash.
    5. Check if an entry exists with the same handle hash in the `mosip_idrepo.handle` table.
    6. Fails the `add_identity` request if an entry exists.
    7. Otherwise, create an identity with UIN and Create an entry in the `mosip_idrepo.handle` table for each selected handle.
    8. Issue credentials with the UIN. As part of handle support, we have made this issuance configurable.
    9. Issue credentials with the handle for each selected handle.
* There were changes in IDA to support handle as a new IDType and also introduced regex-based handle validation.
* Changes in `update_identity` API:
	1. Identify if any handle is selected in the input.
	2. Check if the selected handles are configured as a HANDLE in `identity_schema`(JSON schema validation).
	3. If no handles are selected, proceed with step 6.
	4. If selected, get the salt for the input handles and generate the selected handles salted hash.
	5. Follow below operations in `mosip_idrepo.handle` table.  
		a) If the handle is selected and the same handle is mapped to DIFFERENT user then fail the `update_identity` request.  
		b) If the handle is selected and the same handle is mapped to SAME user then do nothing.  
		c) If the handle is selected and the handle does NOT EXIST in `mosip_idrepo.handle` table, create entry in handle table.  
		d) If there are any unselected handles (when compared with stored selectedHandles and input selectedHandles), mark the handles as deleted in the `mosip_idrepo.handle` table.  
	Note: Add `is_active` and `is_deleted` columns in the `mosip_idrepo.handle` table.
	6. Update identity data (demo, docs & bio) in the uin table.

	In CredentialServiceManager, when we fetch the list of handles for a UIN to issue credentials:
	1. Issue credential event to be raised if the record is active and not deleted.
	2. If the record is deleted, then send `REMOVE_ID` event to IDA.  
	Note: If the UIN will be blocked or deactivated, then revoke credentials for list of handles for a UIN.
	3. We should change in the IDA to acknowledge `REMOVE_ID` events to identity-service. On receiving successful acknowledgment delete the entry from `mosip_idrepo.handle` table.

### How is the credential request ID created for handles?

The RID passed in the `add_identity` request is used as a request ID in the `credential_request_status` table. But when the request has to be sent to the credential request generator, Same request ID is used for UIN credential and for the handle credential a new request ID is generated.

Request ID for each handle is generated using the RID and the handle value. RID is concatenated with the handle value and the SHA-256 hash is generated. Hex encoded value of the generated hash is finally used as the request ID.
 

`# Questions

1. If the system is configured to use more than one functional ID as a handle. Collision between 2 different functional 
IDs result in denying the creation of a handle for a user.
Solution: Need store handle along with handle-type. On every authenticate request, system will expect handle and handle_type as input,
or handle_type should be prefixed to the handle.

It is decided to append the configured postfix to the input handle based on the schema fieldId.

Example: 
Input is phone number -> +9134523233 and the configured postfix is @phone, then the final handle stored in ID-repo is
+9134523233@phone. Now during authentication, users should use "+9134523233@phone" as `individualId`. Authentication 
portals will support the automatic appending of handle-type postfix or could provide an option for the user to choose among 
the list of postfixes(makes sense when more than one handles are supported).

2. Custom user handle can be any unique username chosen/created by the user. Is it required to store this in ID-repo?
Solution: This should be unique and linked to user UIN/VID. eSignet itself can have a feature to create a 
user handle and store the user handle mapped to the verified VID/UIN. When the user tries to authenticate with the 
handle, eSignet finds the mapping and requests the IDA with the mapped VID/UIN (TBD).
