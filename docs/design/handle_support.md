## What is Handle?

A Handle is a unique but changeable ID that`s possessed by the user or auto-generated by the system. It can be a user's email, phone number, an existing functional ID/sectoral ID/national ID in the country. It can also be a username created by the user. 

Typically Handles are IDs that are easy to remember and frequently used by the user. Handles come helpful when the 12/16 digit numbers are too large to remember. In certain cases, MOSIP would be used to replace an existing ID system and the IDs generated by that old system can become a handle in MOSIP and users can use the same to authenticate. This helps to adopt the usage of MOSIP with less user training. 

As handles are revocable they provide strong privacy by default. If a user feels a handle is compromised they could alter and move to a new handle without losing any history of their transactions. 

## Principles

* Users could have more than one handle mapped to his/her UIN.
* Handles should be case-insensitive.
* The usage of handles should be driven through policy.
* Users should be given the freedom to choose which handles to use.

## Create Handle

* Mark a field to be a handle in the Identity schema.
* Introduced reserved field `selectedHandles` that holds the user's selected handle `fieldIds` list.
* Table `mosip_idrepo.handle` will hold the hash of the handle linked with UIN.
* Changes in `add_identity` API:
    1. Identify if any handle is selected in the input.
    2. Check if the selected handles are configured as a HANDLE in `identity_schema`(JSON schema validation).
    3. If no handles are selected, proceed with step 7.
    4. Get the salt for the input handle and generate the selected handle salted hash.
    5. Check if an entry exists with the same handle hash in the `mosip_idrepo.handle` table.
    6. Fails the `add_identity` request if an entry exists.
    7. Otherwise, create an identity with UIN and Create an entry in the `mosip_idrepo.handle` table for each selected handle with status `ACTIVATED`.
    8. Issue credentials with the UIN. As part of handle support, we have made this issuance configurable.
    9. Issue credentials with the handle for each selected handle.
* There were changes in IDA to support handle as a new IDType and also introduced regex-based handle validation.
* Changes in `update_identity` API:

	1. selectedHandles not present or selectedHandles is set as null in the request: ( should consider the saved selectedhandles )

		a. Fields to update are marked as handle in the identity schema:
		 - Check the saved identity object to see if any fields are selected as Handle.
		 - If any input field is selected as handle in the saved object, update the old value as `DELETE` in the `mosip_idrepo.handle` table. And add the new value as handle by considering the previously selectedHandles list in the saved identity object.
		 - If none of the input fields are selected as handle, proceed with (iii)

		b. Fields to update are NOT marked as handle in identity schema, proceed with (iii)

	2. selectedHandles present in the request:

		a. selectedHandles is an empty list:
		 - Fetch the saved identity object, identify the fields selected as handle previously, and update all the previously selected handles as `DELETE`.
		 - Proceed with  (iii)

		b. selectedHandles is not an empty list:
		 - Ignore unknown non-handle fieldIds in the selectedHandles list, before saving identity object cleanup selectedHanldes list to hold only valid fieldIds.
		 - Identify unselected handle fieldIds comparing the selectedHandles in the request and the selectedHandles in the saved object.
		 - update the unselected handles as `DELETE` in the `mosip_idrepo.handle` table.
   		 - If a fieldId is in the selectedHandles list, but not present in the update identity request, we should us the value from savedObject to create handle.
		 - If the valid handle fieldId is found in the selectedHandles list, get the salt for the input handles and generate the selected handles salted hash.
		    - handle hash does NOT EXIST in the `mosip_idrepo.handle` table, create an entry in handle table.
		    - handle hash exists for the SAME user then do nothing.
		    - handle hash exists for the DIFFERENT user then fail the `update_identity` request.
		    - No matter what status the handle entry is in, any new entry with the same handle hash MUST not be allowed.

	3. Update identity data (demo, docs & bio) as requested in the input and publish credentials for UIN and all the handles linked to that UIN.

	Note: selectedHandles is replaced NOT appended in the updateIdentity endpoint.

* Change in the schema:
    - Particular fieldId is marked/unmarked as handle in the published schema, until the identity is updated using the new published schema, previously selected handles will be supported.

* Change in the `mosip_idrepo.handle` table:
    - Add `status` column in the `mosip_idrepo.handle` table.

* Changes in Job: In CredentialServiceManager, when we fetch the list of handles for a UIN to issue credentials:
    - Issue credential event to be raised if the handle status is `ACTIVATED`.
    - If the handle status is `DELETE`, then send `REMOVE_ID` event to IDA and mark the handle status as `DELETE_REQUESTED`.
    - If the UIN will be blocked or deactivated, then revoke credentials for all selected handles for a UIN.
    - We should change in the IDA to acknowledge `REMOVE_ID` event to identity-service as `REMOVE_ID_STATUS` event. On receiving successful acknowledgment from `REMOVE_ID_STATUS` event, delete the entry from `mosip_idrepo.handle` table.


### How is the credential request ID created for handles?

The RID passed in the `add_identity` request is used as a request ID in the `credential_request_status` table. But when the request has to be sent to the credential request generator, Same request ID is used for UIN credential and for the handle credential a new request ID is generated.

Request ID for each handle is generated using the RID and the handle value. RID is concatenated with the handle value and the SHA-256 hash is generated. Hex encoded value of the generated hash is finally used as the request ID.
 

`# Questions

1. If the system is configured to use more than one functional ID as a handle. Collision between 2 different functional 
IDs result in denying the creation of a handle for a user.
Solution: Need store handle along with handle-type. On every authenticate request, system will expect handle and handle_type as input,
or handle_type should be prefixed to the handle.

It is decided to append the configured postfix to the input handle based on the schema fieldId.

Example: 
Input is phone number -> +9134523233 and the configured postfix is @phone, then the final handle stored in ID-repo is
+9134523233@phone. Now during authentication, users should use "+9134523233@phone" as `individualId`. Authentication 
portals will support the automatic appending of handle-type postfix or could provide an option for the user to choose among 
the list of postfixes(makes sense when more than one handles are supported).

2. Custom user handle can be any unique username chosen/created by the user. Is it required to store this in ID-repo?
Solution: This should be unique and linked to user UIN/VID. eSignet itself can have a feature to create a 
user handle and store the user handle mapped to the verified VID/UIN. When the user tries to authenticate with the 
handle, eSignet finds the mapping and requests the IDA with the mapped VID/UIN (TBD).
